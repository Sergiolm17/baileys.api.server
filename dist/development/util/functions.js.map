{"version":3,"file":"functions.js","names":["getAllSession","req","canStart","sessions","fs","readdirSync","path","join","config","sessionDirectory","map","file","existsSync","readFileSync","push","session","JSON","parse","jidToArray","toJid","array","Array","isArray","jid","getJid","jids","split","callWebHook","client","event","data","webhook","webhookUrl","Object","assign","mapperEnable","convert","mapperPrefix","api","post","then","events","includes","type","webhookReadMessage","message","messages","key","fromMe","markReadMessages","remoteJid","e","logger","error","catch","warn","startAllSession","get","getIPAddress","port","secretKey","sendUnread","info","chat","store","chats","all","unreadCount","loadMessages","id","sendUnreadCount","status","debug","sendReadReceipt","participant","update","loadMessage","updateAssign","trim","length","verifyJid","result","onWhatsApp","exists","Error","stringToBoolean","s","test","interfaces","require","networkInterfaces","name","current","loop","alias","family","address","internal","setMaxListners","Number","isInteger","maxListeners","process","setMaxListeners","unlinkAsync","promisify","unlink"],"sources":["../../../node/util/functions.js"],"sourcesContent":["import api from 'axios';\nimport fs from 'fs';\nimport { promisify } from 'util';\nimport { convert } from '../mapper/index';\nimport path from 'path';\n\nexport async function getAllSession(req) {\n  let canStart = [];\n  const sessions = fs.readdirSync(path.join(req.config.sessionDirectory));\n  sessions.map(file => {\n    if (fs.existsSync(path.join(req.config.sessionDirectory, file, 'config.json'))) {\n      let config = fs.readFileSync(path.join(req.config.sessionDirectory, file, 'config.json'));\n      canStart.push({ session: file, config: JSON.parse(config) });\n    }\n  });\n  return canStart;\n}\nexport function jidToArray(toJid) {\n  let array = [];\n  if (Array.isArray(toJid)) {\n    for (let jid of toJid) {\n      jid = getJid(jid);\n      if (jid !== '') {\n        array.push(jid);\n      }\n    }\n  } else {\n    let jids = toJid.split(/\\s*[,;]\\s*/g);\n    for (let jid of jids) {\n      jid = getJid(jid);\n      if (jid !== '') {\n        array.push(jid);\n      }\n    }\n  }\n  return array;\n}\nexport async function callWebHook(client, req, event, data) {\n  const webhook = client?.config.webhookUrl || req.config.webhookUrl || false;\n  if (webhook) {\n    try {\n      data = Object.assign({ event: event, session: client.session }, data);\n      if (req.config.mapperEnable) data = await convert(req.config.mapperPrefix, data);\n      api\n        .post(webhook, data)\n        .then(async () => {\n          try {\n            const events = ['messages.upsert'];\n            if (events.includes(event) && data.data.type === 'notify' && req.config.webhookReadMessage) {\n              for (const message of data.data.messages ? data.data.messages : []) {\n                if (message.key && !message.key.fromMe) {\n                  await markReadMessages(message.key.remoteJid, client, [message]);\n                }\n              }\n            }\n          } catch (e) {\n            req.logger.error(e);\n          }\n        })\n        .catch(e => {\n          req.logger.warn('Error calling webhook', e);\n        });\n    } catch (e) {\n      req.logger.error(e);\n    }\n  }\n}\nexport async function startAllSession(config, logger) {\n  try {\n    await api.get(`http://${getIPAddress()}:${config.port}/api/session/startup/${config.secretKey}`);\n  } catch (e) {\n    logger.error(e);\n  }\n}\nexport async function sendUnread(client, req) {\n  req.logger.info(`Start sending unread messages from session ${client.session}`);\n  try {\n    for (const chat of await client.store.chats.all()) {\n      if (chat.unreadCount > 0) {\n        for (const message of await client.store.loadMessages(chat.id, req.config.sendUnreadCount)) {\n          if (!message.key.fromMe && !(message.status === 4 || message.status === 'READ')) {\n            req.logger.debug(`Send message id ${message.key.id}, fromMe ${message.key.fromMe}, status ${message.status} to webhook`);\n            await callWebHook(client, req, 'messages.upsert', {\n              data: {\n                messages: [message],\n                type: 'notify',\n              },\n            });\n          }\n        }\n      }\n    }\n    req.logger.info(`End send unread messages from session ${client.session}`);\n  } catch (e) {\n    req.logger.error(e);\n  }\n}\nexport async function markReadMessages(jid, client, messages) {\n  for (const message of messages ? messages : []) {\n    if (message.key && !message.key.fromMe) {\n      await client.sendReadReceipt(message.key.remoteJid, message.key.participant, [message.key.id]);\n      let update = await client.store.loadMessage(jid, message.key.id);\n      await client.store.messages[jid].updateAssign(message.key.id, { ...update, status: 'READ' });\n    }\n  }\n}\nexport function getJid(jid) {\n  if (jid.includes('@g.us') || jid.includes('@c.us') || jid.includes('@s.whatsapp.net')) return jid.trim();\n  return jid.includes('-') || jid.split('@')[0].length > 13 ? `${jid}@g.us`.trim() : `${jid}@s.whatsapp.net`.trim();\n}\nexport async function verifyJid(client, jid) {\n  if (jid.includes('@g.us')) {\n    return true;\n  }\n  const [result] = await client.onWhatsApp(jid.trim());\n  if (result?.exists) {\n    return true;\n  }\n  throw new Error(`Jid ${jid.trim()} not registered on WhatsApp`);\n}\nexport function stringToBoolean(s) {\n  return /^(true|1)$/i.test(s);\n}\nexport function getIPAddress() {\n  var interfaces = require('os').networkInterfaces();\n  for (var name in interfaces) {\n    var current = interfaces[name];\n    for (var loop = 0; loop < current.length; loop++) {\n      var alias = current[loop];\n      if (alias.family === 'IPv4' && alias.address !== '127.0.0.1' && !alias.internal) return alias.address;\n    }\n  }\n  return '127.0.0.1';\n}\nexport function setMaxListners(config) {\n  if (config && Number.isInteger(config.maxListeners)) {\n    process.setMaxListeners(config.maxListeners);\n  }\n}\n\nexport let unlinkAsync = promisify(fs.unlink);\n"],"mappings":"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"}