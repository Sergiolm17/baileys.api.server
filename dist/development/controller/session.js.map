{"version":3,"file":"session.js","names":["encrypt","req","res","session","secret","params","authorization","token","headers","secure","config","secretKey","tokenDecrypt","undefined","split","status","json","error","bcrypt","hash","hashFormat","replace","full","create","sessionUtil","SessionUtil","state","createSession","clientsArray","restart","success","restartAll","Object","assign","force","startAll","sessions","getAllSession","map","body","length","client","connected","connection","qrcode","e","logger","logOut","logout","close","info","user"],"sources":["../../../node/controller/session.js"],"sourcesContent":["import SessionUtil from '../util/session';\nimport { clientsArray } from '../util/variable';\nimport bcrypt from 'bcrypt';\nimport { getAllSession } from '../util/functions';\n\nexport async function encrypt(req, res) {\n  const { session, secret } = req.params;\n  const { authorization: token } = req.headers;\n  const secure = req.config.secretKey;\n  let tokenDecrypt = '';\n  if (secret === undefined) {\n    tokenDecrypt = token.split(' ')[0];\n  } else {\n    tokenDecrypt = secret;\n  }\n  if (tokenDecrypt !== secure) {\n    return res.status(400).json({\n      error: 'The secret is incorrect',\n    });\n  }\n  bcrypt.hash(session + secure, 10, function (error, hash) {\n    if (error) return res.status(500).json(error);\n    const hashFormat = hash.replace(/\\//g, '_').replace(/\\+/g, '-');\n    return res.status(201).json({\n      session: session,\n      token: hashFormat,\n      full: `${session}:${hashFormat}`,\n    });\n  });\n}\nexport async function create(req, res) {\n  const { session } = req.params;\n  const sessionUtil = new SessionUtil();\n  await state(req, res);\n  await sessionUtil.createSession(req, clientsArray, session);\n}\nexport async function restart(req, res) {\n  const { session } = req.params;\n  clientsArray[session] = undefined;\n  const sessionUtil = new SessionUtil();\n  await sessionUtil.createSession(req, clientsArray, session, res);\n  return await res.status(201).json({ success: `Restarting sessions ${session}`, session: session });\n}\nexport async function restartAll(req, res) {\n  Object.assign(req, {\n    params: {\n      force: true,\n      ...req.params,\n    },\n  });\n  return await startAll(req, res);\n}\nexport async function startAll(req, res) {\n  const { secret, force = false } = req.params;\n  const { authorization: token } = req.headers;\n  let tokenDecrypt = '';\n  if (secret === undefined) {\n    tokenDecrypt = token.split(' ')[0];\n  } else {\n    tokenDecrypt = secret;\n  }\n  const sessions = await getAllSession(req);\n  if (tokenDecrypt !== req.config.secretKey) {\n    return res.status(400).json({\n      error: 'The token is incorrect',\n    });\n  }\n  sessions.map(async session => {\n    const sessionUtil = new SessionUtil();\n    if (session.config) {\n      Object.assign(req, { body: session.config });\n    }\n    if (force) {\n      clientsArray[session.session] = undefined;\n    }\n    await sessionUtil.createSession(req, clientsArray, session.session, res);\n  });\n  return await res.status(201).json({ success: `${force ? 'Restarting' : 'Starting'} ${sessions.length} sessions`, sessions: sessions });\n}\nexport async function state(req, res) {\n  const { session } = req.params;\n  try {\n    const client = req.client;\n    if (client == null || client.status == null) {\n      return res.status(200).json({ connected: false, session: session });\n    } else {\n      return res.status(200).json({\n        connection: client.status,\n        qrcode: client.qrcode,\n      });\n    }\n  } catch (e) {\n    req.logger.error(e);\n    return res.status(500).json({ connected: false, error: 'The session is not active' });\n  }\n}\nexport async function logOut(req, res) {\n  const { session } = req.params;\n  try {\n    const client = req.client;\n    if (client == null || client.status == null) {\n      return res.status(200).json({ connected: false, session: session });\n    } else {\n      await client.logout();\n      return res.status(200).json({\n        connection: client.status,\n        qrcode: client.qrcode,\n      });\n    }\n  } catch (e) {\n    req.logger.error(e);\n    return res.status(500).json({ error: 'The session is not active' });\n  }\n}\nexport async function close(req, res) {\n  const { session } = req.params;\n  try {\n    const client = req.client;\n    if (client == null || client.status == null) {\n      return res.status(200).json({ connected: false, session: session });\n    } else {\n      clientsArray[session] = undefined;\n      return res.status(200).json({\n        connection: client.status,\n        qrcode: client.qrcode,\n      });\n    }\n  } catch (e) {\n    req.logger.error(e);\n    return res.status(500).json({ error: 'The session is not active' });\n  }\n}\nexport async function info(req, res) {\n  const { session } = req.params;\n  try {\n    const client = req.client;\n    if (client.status == null) {\n      return res.status(200).json({ session: session });\n    } else {\n      return res.status(200).json({\n        connection: client.status,\n        info: { ...client.user, session: session },\n      });\n    }\n  } catch (e) {\n    req.logger.error(e);\n    return res.status(500).json({ error: 'The session is not active' });\n  }\n}"],"mappings":"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"}